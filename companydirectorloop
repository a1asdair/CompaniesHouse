
import chwrapper

import json

import csv

from time import sleep

from urllib.error import HTTPError

###############################################

def getlistofdirectors(companynumber):

        searchnumber = companynumber
 
    # Make the Companies House request  
        response = search_client.officers(searchnumber)
 
        directorslist = response.json()["items"]

        if response.status_code == 200: 
            try:
                return companylist
            except HTTPError:   
                sleep(30)
                print ("Trying again")

        for person in directors:

            try:
                name = person["name"]

            except: 

                name = "."

            try: 

                role = person["officer_role"]

            except: 

                role = "."

            try: 

                appointon = person["appointed_on"]

            except: 

                appoint_on = "."
        
            try: 

                resignedon = person["resigned_on"]

            except: 

                resignedon = "."

            try: 

                dob = person["date_of_birth"]

            except: 

                dob = "."

            try: 

                country = person["country_of_residence"]

            except: 

                country = "."

            try: 

                nationality = person["nationality"]

            except: 

                nationality = "." 

            try: 

                occupation = person["occupation"]

            except: 

                occupation = "."

        return name, role, appointon, resignedon, dob, country, nationality, occupation 

# Companies House token 

search_client = chwrapper.Search(access_token='kvOgVLFW60kS3iMuSqx0lI1uC6g71G1hiN6O80Y-') 

# Read in list of company numbers of matched charities in CSV format     
        
projectpath = "C:/Users/clair/Documents/PhD/Data/CompaniesHouseAPI/"  
 
inputfilepath = projectpath + "matchedcharities.csv" 
 
csvfile = open(inputfilepath, encoding="utf8")
 
fieldnames = ("companynumber")

reader = csv.DictReader( csvfile, fieldnames)

# Open an output file 

outputfilepath = projectpath + "companydirectors.csv"

print("Ready to go...")

with open(outputfilepath, 'w', newline='') as outputcsvfile:

    outputfieldnames = ("companynumber", "name", "role", "appointon", "resignedon", "dob", "country", "nationality", "occupation")

    writerOutput = csv.DictWriter( outputcsvfile, outputfieldnames)
 
    writerOutput.writeheader()

    # Work through each company in the input file 

    for row in reader:
 
        companynumber = row['companynumber']

        # Search Companies House by company number

        directorlist = getlistofdirectors(companynumber)

        # Output the results into a CSV file 

        print("DIRECTOR: ", companynumber, '|', role, '|', name)
        
        writerOutput.writerow({'output': 'OUTPUT', 'companynumber': orgnumber, 'name' : name, 'role' : officer_role, 'appointedon' : appointed_on, 'resignedon' : resigned_on, 'dob' : date_of_birth, 'country' : country_of_residence, 'nationality' : nationality, 'occupation' : occupation})
 
print("Finished! There is a list of company directors by matched charity waiting for you.")


###################################################

##search_client = chwrapper.Search(access_token='kvOgVLFW60kS3iMuSqx0lI1uC6g71G1hiN6O80Y-')

##response = search_client.officers('00664175')

#print(response.json())

##directors = response.json()["items"]

#firstdirector = response.json()["items"][0]

#print()

#print()

#print()

##for person in directors:

##    print(person["name"])

##    print(person["officer_role"])

##    try: print(person["appointed_on"])

##    except: appointed_on = "."
        
##    try: print(person["resigned_on"])

##    except: resigned_on = "."

##    try: print(person["date_of_birth"])

##    except: date_of_birth = "."

##    try: print(person["country_of_residence"])

##    except: country_of_residence = "."

##    try: print(person["nationality"])

##    except: nationality = "." 

##    try: print(person["occupation"])

##   except: occupation = "."

  
